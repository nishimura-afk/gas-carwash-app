# 累計台数一括再計算の不具合 — 説明と解決案

## 1. 概要

洗車機管理システムの「累計台数を再計算」機能を実行したところ、**修正対象以外の他店舗の累計台数が意図せず大きく書き換えられてしまう**事象が発生した。  
ユーザーはスプレッドシートのバージョン履歴で約40分前のリビジョンに復元し、他店舗のデータは元に戻した。  
本ドキュメントは、この事象を Claude 等に調査・修正してもらうための説明と解決案である。

---

## 2. 対象機能の仕様

- **機能名**: 累計台数の一括再計算
- **入口**: Webアプリ「月次更新」タブ内の「累計台数を再計算」ボタン
- **呼び出し**: `google.script.run.recalculateAllAccumulatedCounts()`
- **実装**: `3_DataUpdateService.js` の `recalculateAllAccumulatedCounts()`

**想定している処理内容:**

1. 月次データシート（`月次データ`）の全行を取得する。
2. 「店舗コード＋区別」ごとにグループ化する。
3. 各グループ内で**年月の昇順**にソートする。
4. 各グループについて、**最も古い月から順に**  
   - 本体設置日より前の月: 累計台数 = 0  
   - それ以降: 累計台数 = 前月の累計台数 + 当月の月次台数（列名は「日次台数」）  
   で再計算する。
5. 再計算した累計台数で月次データシートを**一括** `setValues(allData)` で上書きする。
6. 最後に `refreshStatusSummary()` でステータス集計を更新する。

**期待される結果:**  
修正したい1店舗・1区別の累計だけを「累計をこの値に合わせる」で直したあと、再計算を実行すると、その店舗・区別の**その月以降**の累計が正しく連鎖する。**他店舗・他区別の累計は、元の月次台数に基づいて再計算されるだけで、おかしな値に変わるべきではない。**

---

## 3. 発生した事象

- 上記「累計台数を再計算」を1回実行した。
- その結果、**修正対象以外の複数店舗の累計台数が、明らかに誤った値に変わった**（「大きく書き換えられてしまっている」状態）。
- ユーザーはスプレッドシートの「バージョン履歴」から約40分前のリビジョンを復元し、他店舗の累計は元に戻した。
- 修正したかった1店舗の累計も復元により元に戻っており、現状は「反映だけ行い、再計算は実行しない」運用で凌いでいる。

---

## 4. 関連コードの場所

| 項目 | ファイル・関数 |
|------|----------------|
| 一括再計算の本体 | `3_DataUpdateService.js` の `recalculateAllAccumulatedCounts()`（おおよそ 341 行目〜） |
| 月次データの列名 | `1_Setup.js` の `MONTHLY_DATA` ヘッダー: `['年月', '店舗コード', '区別', '日次台数', '累計台数']` |
| 設備マスタ（本体設置日） | `2_DataService.js` の `getEquipmentMasterData()` |
| キャッシュ更新 | `2_DataService.js` の `refreshStatusSummary()` |
| 設定・シート取得 | `0_Config.js` の `getConfig()`, `getSheet()` |

---

## 5. 想定される原因（調査の切り口）

以下は、他店舗の累計がおかしくなる可能性がある要因の候補である。

1. **日付の解釈・タイムゾーン**  
   - 月次データの「年月」列がスプレッドシート上で Date または文字列で保存されている場合、`parseDate(allData[i][idxDate])` や `new Date(...)` の解釈が環境・タイムゾーンでずれ、**ソート順が意図と異なる**可能性がある。  
   - その結果、あるグループ内で「前月」が誤認識され、`prevAccum` が別グループの値に近いなど、累計が連鎖的にずれる。

2. **グループキーのゆらぎ**  
   - `groupKey(row)` が `row[idxShop]` と `row[idxMachine]]\) の文字列結合。  
   - 前後のスペースや全角/半角の差で、本来同じ「店舗コード＋区別」が別キーに分かれたり、逆に別店舗が同じキーにまとまったりする可能性（あまり起こりにくいが、データ品質次第）。

3. **本体設置日の型**  
   - `getEquipmentMasterData()` で取得した `本体設置日` が Date ではなく文字列の場合、`installDate.getFullYear()` 等で例外や不正値になり、`installMonthStart` が正しく設定されない。  
   - そのグループ内の「0にリセット」の境界がずれ、累計の初期値や前月累計の取り違えにつながる可能性。

4. **月次台数（日次台数列）の欠損・型**  
   - 空セルや文字列で `parseFloat(allData[i][idxDaily])` が NaN になり、`|| 0` で 0 にしている。  
   - その月の「月次台数」が 0 として再計算され、累計が前月と同じになる。  
   - これが複数店舗で起きると、見た目上「他店舗の累計がおかしくなった」ように見える可能性がある。

5. **setValues の範囲と allData の対応**  
   - `getDataRange().getValues()` と `range.setValues(allData)` の行数・列数が一致しているか。  
   - 空行や結合セルなどで範囲と配列の対応がずれていないか（GAS の getDataRange の仕様も含めて確認するとよい）。

---

## 6. 解決案の提案

1. **再計算ロジックの単体検証**  
   - 月次データの**サンプル（数店舗・数ヶ月分）**を用意し、`recalculateAllAccumulatedCounts()` 実行前後の `allData` をログまたはスプレッドシートに書き出して比較する。  
   - 特に「店舗コード＋区別」ごとのソート結果、各グループの `prevAccum` の変化、本体設置日前後の 0 リセットが意図どおりか確認する。

2. **日付の正規化**  
   - 「年月」列を「その月の1日 00:00:00」の Date に統一してからソート・比較する（タイムゾーンを Session.getScriptTimeZone() 等で明示するのも有効）。

3. **グループキーの正規化**  
   - `groupKey(row)` 内で `String(row[idxShop]).trim()` と `String(row[idxMachine]).trim()` を使うなど、空白・型のゆらぎを吸収する。

4. **本体設置日の扱いの統一**  
   - 取得した `本体設置日` を必ず `new Date(...)` で Date にし、無効な場合は `installMonthStart = null` として「設置日前は0」の判定だけ安全にスキップする。

5. **再計算前にバックアップを取る**  
   - 再計算実行前に、月次データシートを別シート（例: `月次データ_バックアップ`）にコピーする処理を追加する。  
   - 不具合が再発した場合に、ユーザーが手動で復元しやすくする。

6. **オプション: 対象店舗・区別だけ再計算するモード**  
   - 全店舗一括ではなく、「指定した店舗コード＋区別」のみそのグループ内で累計を再計算する関数を用意する。  
   - 他店舗に一切手を加えないため、今回のような事象のリスクを減らせる。

---

## 7. リポジトリ・環境

- スクリプトは Git で管理され、リモートに push 済みである。
- Google Apps Script（GAS）で動作し、スプレッドシート（月次データ・設備マスタ・ステータス集計など）を読み書きしている。

---

## 8. 依頼したいこと（Claude 向け）

- 上記 **5. 想定される原因** を踏まえ、`3_DataUpdateService.js` の `recalculateAllAccumulatedCounts()` を調査し、**他店舗の累計が書き換えられる原因**を特定してください。
- 可能であれば、**修正パッチ**（差分）または修正方針を提案してください。
- 必要に応じて、**再計算前のバックアップ**や**対象店舗のみ再計算するオプション**の実装案も検討してください。
