<!-- Monthly Update View (Batch Input / Auto Cleanup) -->
<div class="space-y-4">
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-calendar-check mr-2"></i>月次データ一括入力</h2>
      <p class="text-sm text-gray-600">各店舗の当月稼働台数を入力してください。入力内容は自動的に端末に一時保存されます。</p>
    </div>
    <button onclick="loadMonthlyInput(true)" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold transition">
      <i class="fas fa-sync-alt mr-1"></i> 最新情報を取得
    </button>
  </div>
  
  <div class="flex flex-col md:flex-row justify-between items-center bg-blue-50 p-4 rounded border border-blue-200">
    <div class="flex items-center space-x-2 bg-white p-2 rounded shadow">
      <label class="text-sm font-bold text-gray-700">対象年月:</label>
      <input type="month" id="batch-month" class="border rounded p-1 text-lg font-bold text-gray-700" onchange="handleMonthChange()">
    </div>
  </div>
  
  <div class="overflow-x-auto border rounded-lg shadow bg-white">
    <table class="w-full text-sm text-left whitespace-nowrap">
      <thead class="bg-gray-100 text-gray-700 sticky top-0 z-10">
        <tr>
          <th class="p-3 border-b">店舗名 / 店舗CD</th>
          <th class="p-3 border-b">区別</th>
          <th class="p-3 border-b">現在の累計</th>
          <th class="p-3 border-b w-40">当月稼働台数 (入力)</th>
        </tr>
      </thead>
      <tbody id="monthly-batch-body" class="divide-y">
        <tr><td colspan="4" class="p-4 text-center">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="flex justify-between items-center pt-4 pb-8">
    <div id="draft-status" class="text-sm text-gray-500 italic"></div>
    <button onclick="submitBatchMonthly()" class="bg-green-600 text-white font-bold py-3 px-8 rounded shadow hover:bg-green-700 transition transform hover:scale-105">
      <i class="fas fa-save mr-2"></i>一括保存する
    </button>
  </div>

  <!-- 修正モード -->
  <div class="border-t pt-6 mt-8 space-y-4">
    <div class="flex items-center gap-4">
      <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-edit mr-2"></i>月次データの個別修正</h3>
      <button type="button" id="toggle-edit-mode" onclick="toggleEditMode()" class="bg-amber-100 hover:bg-amber-200 text-amber-800 px-4 py-2 rounded text-sm font-bold transition">
        修正モードを開く
      </button>
    </div>
    <div id="edit-mode-panel" class="hidden bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-4">
      <div class="text-sm text-gray-700 space-y-2">
        <p><strong>いつどちらを使うか</strong></p>
        <ul class="list-disc list-inside ml-2 space-y-1">
          <li><strong>月次台数で修正</strong> … その月の「1ヶ月分の洗車台数」だけを直したいとき（例: 2,000台と入力し忘れていた）。</li>
          <li><strong>累計を直接指定</strong> … 表示が85,000台だが実際は80,000台のように、<strong>誤差が1ヶ月分（約2,000台）を超えるとき</strong>。累計を80,000に合わせて「反映」を押すと、その月の月次台数は自動で「80,000 − 前月累計」に修正され、<strong>その店舗・区別の以降の月も自動で連鎖</strong>します（他店舗には触れません）。</li>
        </ul>
        <p><strong>月平均台数</strong> … 直近12ヶ月の月次台数から自動計算されています。上記で月次台数や累計を修正すると、再表示時に自動で更新されます。店舗一覧が空の場合は「最新情報を取得」を先に実行してください。</p>
      </div>
      <div class="flex flex-wrap items-end gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1">対象年月</label>
          <input type="month" id="edit-month" class="border rounded p-2">
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1">店舗</label>
          <select id="edit-shop" class="border rounded p-2 min-w-[180px]" onchange="fillEditPositions()">
            <option value="">選択してください</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1">区別</label>
          <select id="edit-pos" class="border rounded p-2 min-w-[100px]">
            <option value="">選択してください</option>
          </select>
        </div>
        <button type="button" onclick="loadMonthlyDataForEdit()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">
          <i class="fas fa-search mr-1"></i>読み込む
        </button>
      </div>
      <div id="edit-data-area" class="hidden border-t border-amber-200 pt-4 mt-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">月次台数（編集）</label>
            <input type="number" id="edit-daily" min="0" class="border rounded p-2 w-full" placeholder="0">
            <p class="text-xs text-gray-500 mt-1">その月の1ヶ月分の洗車台数だけを直すときに変更</p>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">累計台数（表示）</label>
            <p id="edit-accum-preview" class="p-2 bg-gray-100 rounded text-right font-mono">—</p>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-4">
          <button type="button" onclick="saveMonthlyCorrection()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">
            <i class="fas fa-save mr-1"></i>月次で保存
          </button>
          <span class="text-gray-500">または</span>
          <div class="flex items-center gap-2">
            <label class="text-sm font-bold text-gray-700">累計をこの値に合わせる:</label>
            <input type="number" id="edit-accum-target" min="0" class="border rounded p-2 w-28 text-right font-mono" placeholder="80000">
            <span class="text-sm text-gray-600">台</span>
            <button type="button" onclick="saveMonthlyCorrectionByAccum()" class="bg-purple-600 text-white px-4 py-2 rounded font-bold hover:bg-purple-700">
              反映
            </button>
          </div>
        <p class="text-xs text-gray-600 mt-2"><strong>累計を書き換える手順:</strong> 対象年月・店舗・区別を選んで「読み込む」→「累計をこの値に合わせる」に希望の数値（例: 80000）を入力→「反映」を押すだけ。その店舗・区別のその月以降が自動で連鎖し、他店舗には一切触れません。</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let carWashCache = [];

function loadMonthlyInput(forceRefresh = false) {
  // デフォルト日付の設定
  const today = new Date();
  const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  const yyyy = lastMonth.getFullYear();
  const mm = ('0' + (lastMonth.getMonth() + 1)).slice(-2);
  
  const monthInput = document.getElementById('batch-month');
  if (!monthInput.value) {
    monthInput.value = `${yyyy}-${mm}`;
  }

  // ★追加: 画面を開いたついでに、古いゴミデータを掃除する
  cleanupOldDrafts(monthInput.value);

  // キャッシュ利用
  if (!forceRefresh && window.g_cache && window.g_cache.management) {
     renderBatchForm(window.g_cache.management);
     return;
  }

  showLoading(true);
  google.script.run
    .withSuccessHandler(list => {
      // キャッシュに保存（managementと共有できるデータ構造なら再利用）
      if(window.g_cache) window.g_cache.management = list;
      renderBatchForm(list);
    })
    .withFailureHandler(e => { showLoading(false); alert('データ取得失敗: ' + e); })
    .getCarWashList();
}

window.loadMonthlyInput = loadMonthlyInput;

function renderBatchForm(list) {
  carWashCache = list; 
  showLoading(false);
  const tbody = document.getElementById('monthly-batch-body');
  tbody.innerHTML = '';

  if (!list || list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">データがありません</td></tr>';
    return;
  }

  list.sort((a, b) => a['店舗コード'] - b['店舗コード']);

  list.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.className = "hover:bg-blue-50 transition";
    const uniqueKey = `${item['店舗コード']}_${item['区別']}`;

    tr.innerHTML = `
      <td class="p-3">
        <div class="font-bold text-gray-800">${item['店舗名']}</div>
        <div class="text-xs text-gray-500 font-mono">${item['店舗コード']}</div>
      </td>
      <td class="p-3 font-mono">${item['区別']}</td>
      <td class="p-3 text-gray-500">
        ${Number(item['累計台数']).toLocaleString()} 台
      </td>
      <td class="p-3 bg-yellow-50">
        <input type="number" id="input-${index}" 
          data-key="${uniqueKey}"
          class="w-full border border-gray-300 rounded p-2 text-right font-bold focus:ring-2 focus:ring-blue-500 outline-none" 
          placeholder="0" min="0" tabIndex="${index + 1}"
          onkeydown="handleEnterKey(event, ${index})"
          oninput="saveDraft('${uniqueKey}', this.value)">
      </td>
    `;
    tbody.appendChild(tr);
  });

  restoreDrafts();
}

function handleMonthChange() {
  if (carWashCache.length > 0) {
    renderBatchForm(carWashCache);
  }
}

function handleEnterKey(event, currentIndex) {
  if (event.key === 'Enter') {
    event.preventDefault();
    const nextInput = document.getElementById(`input-${currentIndex + 1}`);
    if (nextInput) {
      nextInput.focus();
      nextInput.select();
    }
  }
}

function getDraftKey() {
  const month = document.getElementById('batch-month').value;
  return `carwash_draft_${month}`;
}

function saveDraft(uniqueKey, value) {
  const storageKey = getDraftKey();
  let drafts = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  if (value === "") {
    delete drafts[uniqueKey];
  } else {
    drafts[uniqueKey] = value;
  }
  
  localStorage.setItem(storageKey, JSON.stringify(drafts));
  updateDraftStatus();
}

function restoreDrafts() {
  const storageKey = getDraftKey();
  const drafts = JSON.parse(localStorage.getItem(storageKey) || '{}');
  let restoredCount = 0;

  const inputs = document.querySelectorAll('input[type="number"][data-key]');
  inputs.forEach(input => {
    const key = input.dataset.key;
    if (drafts[key] !== undefined) {
      input.value = drafts[key];
      input.classList.add('bg-yellow-100'); 
      restoredCount++;
    } else {
      input.value = ''; 
      input.classList.remove('bg-yellow-100');
    }
  });

  updateDraftStatus(restoredCount > 0);
}

// ★追加: 古いドラフトデータの自動削除機能
function cleanupOldDrafts(currentMonthStr) {
  if (!currentMonthStr) return;
  
  const allKeys = Object.keys(localStorage);
  const currentKey = `carwash_draft_${currentMonthStr}`;

  allKeys.forEach(key => {
    // このアプリのドラフトデータかつ、現在の月ではない場合
    if (key.startsWith('carwash_draft_') && key !== currentKey) {
      const draftMonth = key.replace('carwash_draft_', '');
      
      // 3ヶ月以上前のデータなら削除
      const monthsDiff = getMonthsDiff(draftMonth, currentMonthStr);
      if (monthsDiff > 3) {
        localStorage.removeItem(key);
        // console.log(`Cleaned up old draft: ${key}`);
      }
    }
  });
}

function getMonthsDiff(month1, month2) {
  // month1(old), month2(new) format: YYYY-MM
  const d1 = new Date(month1 + '-01');
  const d2 = new Date(month2 + '-01');
  return (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
}

function clearCurrentDraft() {
  const storageKey = getDraftKey();
  localStorage.removeItem(storageKey);
  updateDraftStatus();
}

function updateDraftStatus(hasDrafts) {
  const statusEl = document.getElementById('draft-status');
  if (hasDrafts || localStorage.getItem(getDraftKey())) {
    statusEl.innerHTML = '<i class="fas fa-save mr-1"></i>入力内容は端末に自動保存されています';
  } else {
    statusEl.innerText = '';
  }
}

function submitBatchMonthly() {
  const monthVal = document.getElementById('batch-month').value;
  if (!monthVal) {
    alert('対象年月を選択してください');
    return;
  }
  
  const updates = [];
  const dateStr = monthVal + '-01'; 

  carWashCache.forEach((item, index) => {
    const inputEl = document.getElementById(`input-${index}`);
    const val = inputEl.value;
    
    if (val !== "") {
      updates.push({
        dateMonth: dateStr,
        shopCode: item['店舗コード'],
        machineIdentifier: item['区別'],
        dailyCount: Number(val)
      });
    }
  });

  if (updates.length === 0) {
    alert('入力されたデータがありません。台数を入力してください。');
    return;
  }

  const confirmMsg = `${monthVal}分として、${updates.length}件のデータを保存しますか？\n（同月のデータは上書き修正されます）`;
  if (!confirm(confirmMsg)) return;

  showLoading(true);
  google.script.run
    .withSuccessHandler((res) => {
      showLoading(false);
      clearCurrentDraft();
      // キャッシュクリアして再読み込み
      if(window.clearCache) window.clearCache('management'); 
      
      alert('保存が完了しました。\nバックグラウンドで集計を更新しています。');
      renderBatchForm(carWashCache);
    })
    .withFailureHandler(e => {
      showLoading(false);
      alert('保存エラー: ' + e);
    })
    .recordMonthlyUpdate(updates);
}

// --- 修正モード ---
function toggleEditMode() {
  const panel = document.getElementById('edit-mode-panel');
  const btn = document.getElementById('toggle-edit-mode');
  if (panel.classList.contains('hidden')) {
    panel.classList.remove('hidden');
    btn.textContent = '修正モードを閉じる';
    if (!document.getElementById('edit-shop').options.length || document.getElementById('edit-shop').options.length === 1) {
      fillEditShopOptions();
    }
  } else {
    panel.classList.add('hidden');
    btn.textContent = '修正モードを開く';
    document.getElementById('edit-data-area').classList.add('hidden');
  }
}

function fillEditShopOptions() {
  const sel = document.getElementById('edit-shop');
  sel.innerHTML = '<option value="">選択してください</option>';
  const seen = new Set();
  (carWashCache || []).forEach(item => {
    if (!item['店舗コード'] || seen.has(item['店舗コード'])) return;
    seen.add(item['店舗コード']);
    const opt = document.createElement('option');
    opt.value = item['店舗コード'];
    opt.textContent = item['店舗名'] + ' (' + item['店舗コード'] + ')';
    sel.appendChild(opt);
  });
}

function fillEditPositions() {
  const shopCode = document.getElementById('edit-shop').value;
  const sel = document.getElementById('edit-pos');
  sel.innerHTML = '<option value="">選択してください</option>';
  if (!shopCode || !carWashCache) return;
  carWashCache.filter(item => item['店舗コード'] === shopCode).forEach(item => {
    const opt = document.createElement('option');
    opt.value = item['区別'];
    opt.textContent = item['区別'];
    sel.appendChild(opt);
  });
  document.getElementById('edit-data-area').classList.add('hidden');
}

let editState = { yearMonth: '', shopCode: '', machineIdentifier: '' };

function loadMonthlyDataForEdit() {
  const yearMonth = document.getElementById('edit-month').value;
  const shopCode = document.getElementById('edit-shop').value;
  const machineIdentifier = document.getElementById('edit-pos').value;
  if (!yearMonth || !shopCode || !machineIdentifier) {
    alert('対象年月・店舗・区別をすべて選択してください。');
    return;
  }
  showLoading(true);
  google.script.run
    .withSuccessHandler((data) => {
      showLoading(false);
      editState = { yearMonth, shopCode, machineIdentifier };
      const area = document.getElementById('edit-data-area');
      if (!data) {
        area.classList.add('hidden');
        alert('該当する月次データがありません。');
        return;
      }
      document.getElementById('edit-daily').value = data.dailyCount;
      document.getElementById('edit-accum-preview').textContent = (data.accumCount != null ? Number(data.accumCount).toLocaleString() : '—') + ' 台（読み込み時）';
      document.getElementById('edit-accum-target').value = data.accumCount != null ? data.accumCount : '';
      area.classList.remove('hidden');
    })
    .withFailureHandler(e => {
      showLoading(false);
      alert('取得エラー: ' + e);
    })
    .getMonthlyDataForEdit(yearMonth, shopCode, machineIdentifier);
}

function saveMonthlyCorrection() {
  if (!editState.yearMonth || !editState.shopCode || !editState.machineIdentifier) {
    alert('先に「読み込む」でデータを読み込んでください。');
    return;
  }
  const dailyCount = document.getElementById('edit-daily').value;
  if (dailyCount === '' || Number(dailyCount) < 0) {
    alert('月次台数を入力してください。');
    return;
  }
  if (!confirm('この内容で上書き保存しますか？\n（該当月のデータのみ更新されます）')) return;
  showLoading(true);
  google.script.run
    .withSuccessHandler((res) => {
      showLoading(false);
      if (res && res.error) {
        alert(res.error);
        return;
      }
      alert('保存しました。');
      loadMonthlyDataForEdit();
    })
    .withFailureHandler(e => {
      showLoading(false);
      alert('保存エラー: ' + e);
    })
    .saveMonthlyDataCorrection(editState.yearMonth, editState.shopCode, editState.machineIdentifier, Number(dailyCount));
}

function saveMonthlyCorrectionByAccum() {
  if (!editState.yearMonth || !editState.shopCode || !editState.machineIdentifier) {
    alert('先に「読み込む」でデータを読み込んでください。');
    return;
  }
  const targetAccum = document.getElementById('edit-accum-target').value;
  if (targetAccum === '' || Number(targetAccum) < 0) {
    alert('累計の値を入力してください。');
    return;
  }
  if (!confirm('この月の累計を ' + Number(targetAccum).toLocaleString() + ' 台に合わせます。\nその月の月次台数は自動で「累計 − 前月累計」に変更されます。よろしいですか？')) return;
  showLoading(true);
  google.script.run
    .withSuccessHandler((res) => {
      showLoading(false);
      if (res && res.error) {
        alert(res.error);
        return;
      }
      alert('反映しました。この店舗・区別のその月以降は自動で連鎖して更新されています。');
      loadMonthlyDataForEdit();
    })
    .withFailureHandler(e => {
      showLoading(false);
      alert('エラー: ' + e);
    })
    .saveMonthlyDataCorrectionByAccum(editState.yearMonth, editState.shopCode, editState.machineIdentifier, Number(targetAccum));
}

</script>