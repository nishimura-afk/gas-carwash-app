<!-- Completion Report View -->
<div class="space-y-4">
  <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
    <p class="text-blue-700 font-bold"><i class="fas fa-check-circle mr-2"></i>作業完了報告</p>
    <p class="text-sm text-blue-600">スケジュールされた交換作業が完了したら、ここで報告を行ってください。マスタおよび履歴が自動更新されます。</p>
  </div>

  <div id="complete-list-container" class="grid grid-cols-1 gap-4">
    <!-- Tasks will be injected here -->
  </div>
</div>

<!-- Modal for Input -->
<div id="complete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h3 class="text-lg font-bold mb-4 text-gray-800">完了詳細入力</h3>
    <!-- 行番号ではなく、ユニークIDを保持する -->
    <input type="hidden" id="comp-id">
    <input type="hidden" id="comp-row-num"> <!-- UI削除用に保持 -->
    <input type="hidden" id="comp-part-name">
    
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-gray-600">完了日</label>
      <input type="date" id="comp-date" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none">
      <p class="text-xs text-gray-500 mt-1">※初期値は予定日です</p>
    </div>
    
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-gray-600">
        完了時累計台数
        <span id="count-required-badge" class="ml-2 text-xs bg-red-100 text-red-600 px-1 rounded hidden">必須</span>
      </label>
      <input type="number" id="comp-count" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例: 50123">
      <p id="count-optional-text" class="text-xs text-gray-400 mt-1">※布ブラシ以外は入力不要です</p>
    </div>
    
    <div class="flex justify-end space-x-2">
      <button onclick="closeCompModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
      <button onclick="submitCompletion()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">確定</button>
    </div>
  </div>
</div>

<script>
function completeInit() {
  showLoading(true);
  google.script.run
    .withSuccessHandler(renderTasks)
    .getScheduledTasksForCompletion();
}

function renderTasks(tasks) {
  showLoading(false);
  const container = document.getElementById('complete-list-container');
  container.innerHTML = '';
  
  if (tasks.length === 0) {
    container.innerHTML = '<div class="p-8 text-center text-gray-500 bg-white rounded border">未完了のスケジュールはありません</div>';
    return;
  }

  tasks.forEach(task => {
    const card = document.createElement('div');
    // UI削除用にrowNumberを使うが、データ送信はIDを使う
    card.id = `task-card-${task.rowNumber}`;
    card.className = "bg-white p-4 rounded shadow border flex flex-col md:flex-row justify-between items-start md:items-center gap-4 transition hover:shadow-md";
    
    // openCompModal に task.id を渡す
    card.innerHTML = `
      <div>
        <div class="font-bold text-xl text-blue-900">${task['店舗名']}</div>
        <div class="text-sm font-bold text-gray-800 mt-1">
          <i class="fas fa-tools text-gray-500 mr-1"></i>${task['部品名']} 交換
        </div>
        <div class="text-xs text-gray-500 mt-1">
          予定日: ${task['予定日']} | 機種: ${task['区別']} (CD:${task['店舗コード']})
        </div>
      </div>
      <button onclick="openCompModal('${task.id}', ${task.rowNumber}, '${task['予定日']}', '${task['部品名']}')" class="w-full md:w-auto bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-bold shadow-sm whitespace-nowrap">
        完了報告
      </button>
    `;
    container.appendChild(card);
  });
}

function openCompModal(id, rowNum, scheduledDate, partName) {
  document.getElementById('comp-id').value = id;
  document.getElementById('comp-row-num').value = rowNum;
  document.getElementById('comp-part-name').value = partName;
  
  if(scheduledDate) {
    document.getElementById('comp-date').value = scheduledDate.replace(/\//g, '-');
  } else {
    document.getElementById('comp-date').valueAsDate = new Date();
  }
  
  const isBrush = partName.includes('布ブラシ');
  const countInput = document.getElementById('comp-count');
  
  if (isBrush) {
    document.getElementById('count-required-badge').classList.remove('hidden');
    document.getElementById('count-optional-text').classList.add('hidden');
    countInput.placeholder = "必須入力 (例: 50123)";
  } else {
    document.getElementById('count-required-badge').classList.add('hidden');
    document.getElementById('count-optional-text').classList.remove('hidden');
    countInput.placeholder = "任意入力";
    countInput.value = ""; 
  }

  document.getElementById('complete-modal').classList.remove('hidden');
}

function closeCompModal() {
  document.getElementById('complete-modal').classList.add('hidden');
}

function submitCompletion() {
  const id = document.getElementById('comp-id').value;
  const rowNum = document.getElementById('comp-row-num').value;
  const date = document.getElementById('comp-date').value;
  let count = document.getElementById('comp-count').value;
  const partName = document.getElementById('comp-part-name').value;
  
  if (!date) {
    alert('完了日は必須です');
    return;
  }
  
  if (partName.includes('布ブラシ') && !count) {
    alert('布ブラシ交換の場合は「完了時累計台数」が必須です');
    return;
  }
  
  if (!count) count = 0;
  
  showLoading(true);
  closeCompModal();
  
  // IDを使って完了処理を呼び出す
  google.script.run
    .withSuccessHandler(() => {
      showLoading(false);
      alert('完了報告を記録しました');
      
      const card = document.getElementById(`task-card-${rowNum}`);
      if (card) {
        card.remove();
      }

      const container = document.getElementById('complete-list-container');
      if (container.children.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500 bg-white rounded border">未完了のスケジュールはありません</div>';
      }
      
      completeInit();
    })
    .withFailureHandler(e => {
      showLoading(false);
      alert('エラー: ' + e);
    })
    .completeExchange(id, date, count);
}
</script>