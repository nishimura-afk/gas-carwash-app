
-- Management View -->
<div class="space-y-4">
  <div class="flex justify-between items-center">
    <div>
      <h2 class="text-lg font-bold">全洗車機ステータス一覧</h2>
      <div class="text-xs text-gray-500 pt-1">※<i class="fas fa-sticky-note"></i>アイコンで次回作業のメモを残せます</div>
    </div>
    <button onclick="managementInit()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold transition">
      <i class="fas fa-sync-alt mr-1"></i> 最新情報を取得
    </button>
  </div>
  
  <!-- 選択操作ボタン -->
  <div class="flex gap-3 mb-2">
    <button onclick="openPartsSelectionModal('register')" id="btn-register" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold shadow disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
      <i class="fas fa-check-circle mr-2"></i>選択した機械を案件リストに登録
    </button>
    <button onclick="openPartsSelectionModal('draft')" id="btn-draft" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded font-bold shadow disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
      <i class="fas fa-envelope mr-2"></i>選択した機械のメール下書き作成
    </button>
  </div>
  
  <div class="overflow-x-auto border rounded-lg shadow bg-white">
    <table class="w-full text-sm text-left whitespace-nowrap">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-3 border-b text-center">
            <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" class="cursor-pointer">
          </th>
          <th class="p-3 border-b">店舗名</th>
          <th class="p-3 border-b">区別</th>
          <th class="p-3 border-b text-right">累計台数</th>
          <th class="p-3 border-b text-right bg-blue-50">月平均</th>
          <th class="p-3 border-b">レール状況</th>
          <th class="p-3 border-b">ブラシ状況</th>
          <th class="p-3 border-b">本体状況</th>
          <th class="p-3 border-b text-center bg-green-50">クリーナー</th>
          <th class="p-3 border-b text-center bg-orange-50">SB</th>
          <th class="p-3 border-b">設置日</th>
          <th class="p-3 border-b text-center">メモ</th>
        </tr>
      </thead>
      <tbody id="mgmt-table-body" class="divide-y bg-white">
        <tr><td colspan="12" class="p-4 text-center">データを取得中...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- メモ編集モーダル -->
<div id="memo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h3 class="text-lg font-bold mb-2 text-gray-800"><i class="fas fa-edit mr-2"></i>次回付帯作業メモ</h3>
    <p class="text-xs text-gray-500 mb-4">次回アラート発生時、メール本文にこのメモが自動挿入されます。（例：看板交換、土間塗装など）</p>
    
    <input type="hidden" id="memo-shop-code">
    <input type="hidden" id="memo-machine-id">
    
    <textarea id="memo-text" class="w-full border rounded p-2 h-32 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ここに入力してください..."></textarea>
    
    <div class="flex justify-end space-x-2 mt-4">
      <button onclick="closeMemoModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
      <button onclick="saveMemo()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">保存する</button>
    </div>
  </div>
</div>

<!-- 部品選択モーダル -->
<div id="parts-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
    <h3 class="text-lg font-bold mb-4 text-gray-800">
      <i class="fas fa-cog mr-2"></i>対象部品の選択
    </h3>
    <p class="text-xs text-gray-500 mb-4">各機械について、対象となる部品を選択してください。</p>
    
    <div id="parts-selection-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">
      <p class="text-yellow-800 text-sm font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>補助金対象店舗が含まれています。返金義務が発生する可能性があります。</p>
    </div>
    
    <div id="parts-selection-list" class="space-y-3 mb-4">
      <!-- 動的に生成 -->
    </div>
    
    <div class="flex justify-end space-x-2 mt-6">
      <button onclick="closePartsSelectionModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
      <button onclick="confirmPartsSelection()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">確定</button>
    </div>
  </div>
</div>

<script>
function managementInit() {
  showLoading(true);
  // 設備構成キャッシュをクリア
  window.equipmentCache = {};
  
  // 設備構成情報を一括取得
  google.script.run
    .withSuccessHandler(function(equipmentMap) {
      // 設備構成情報をキャッシュに保存
      window.equipmentCache = equipmentMap || {};
      
      // 洗車機リストを取得
      google.script.run
        .withSuccessHandler(renderManagement)
        .withFailureHandler(e => { showLoading(false); alert('取得失敗: ' + e); })
        .getCarWashList();
    })
    .withFailureHandler(function(e) {
      console.warn('設備構成情報取得エラー:', e);
      window.equipmentCache = {};
      // エラーでも洗車機リストは取得する
      google.script.run
        .withSuccessHandler(renderManagement)
        .withFailureHandler(err => { showLoading(false); alert('取得失敗: ' + err); })
        .getCarWashList();
    })
    .getAllShopEquipment();
}

// グローバル変数：選択された機械のデータを保持
let selectedMachinesData = [];
let currentActionType = null; // 'register' or 'draft'

function renderManagement(list) {
  showLoading(false);
  const tbody = document.getElementById('mgmt-table-body');
  tbody.innerHTML = '';
  
  if(!list || list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" class="p-4 text-center">データがありません</td></tr>';
    return;
  }

  list.sort((a, b) => {
    if (a['店舗コード'] < b['店舗コード']) return -1;
    if (a['店舗コード'] > b['店舗コード']) return 1;
    return 0;
  });

  const subsidyTargetsFallback = ['徳島石井', '小松島', '紀三井寺', '坂出'];

  list.forEach((row, index) => {
    const tr = document.createElement('tr');
    tr.className = "hover:bg-gray-50 transition";
    tr.dataset.shopCode = row['店舗コード'];
    tr.dataset.machineId = row['区別'];
    tr.dataset.index = index;
    
    // 表示用変数を用意
    let railStatusText = row['レールステータス'];
    let brushStatusText = row['ブラシステータス'];
    const bodyStatus = row['本体ステータス'];

    let railColor = 'text-gray-600';
    let brushColor = 'text-gray-600';
    const bodyColor = bodyStatus === '交換準備' ? 'text-red-600 font-bold' : 'text-gray-600';

    // ★修正: 本体が「交換準備」なら、他部品のステータスを「-」にして完全に消す
    if (bodyStatus === '交換準備') {
      railStatusText = '-';
      brushStatusText = '-';
      railColor = 'text-gray-300'; // 薄いグレーにして目立たなくする
      brushColor = 'text-gray-300';
    } else {
      // 通常時の色判定（アラートなら赤くする）
      if (railStatusText === '通知') {
        railColor = 'text-red-600 font-bold';
      }
      if (brushStatusText && brushStatusText.includes('通知')) {
        brushColor = 'text-red-600 font-bold';
      }
    }

    let isSubsidyTarget = false;
    if (typeof row['isSubsidy'] !== 'undefined') {
      isSubsidyTarget = row['isSubsidy'];
    } else {
      isSubsidyTarget = subsidyTargetsFallback.some(target => row['店舗名'].includes(target));
    }

    let subsidyBadge = '';
    if (isSubsidyTarget) {
      subsidyBadge = `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200" title="補助金対象機">補助金</span>`;
    }

    const memoContent = row['nextWorkMemo'] || "";
    const memoIconClass = memoContent ? "text-blue-600" : "text-gray-300 hover:text-gray-500";
    const memoTitle = memoContent ? "メモあり: " + memoContent : "メモを追加";

    // データ属性にステータス情報を保存
    tr.dataset.railStatus = row['レールステータス'];
    tr.dataset.brushStatus = row['ブラシステータス'];
    tr.dataset.bodyStatus = bodyStatus;
    tr.dataset.shopName = row['店舗名'];
    tr.dataset.isSubsidy = isSubsidyTarget;
    tr.dataset.nextWorkMemo = memoContent;

    tr.innerHTML = `
      <td class="p-3 text-center">
        <input type="checkbox" class="machine-checkbox cursor-pointer" onchange="updateButtonStates()" data-shop-code="${row['店舗コード']}" data-machine-id="${row['区別']}">
      </td>
      <td class="p-3 font-bold text-gray-700 flex items-center">${row['店舗名']}${subsidyBadge} <span class="ml-2 text-xs text-gray-400 font-mono">${row['店舗コード']}</span></td>
      <td class="p-3 text-center">${row['区別']}</td>
      <td class="p-3 text-right font-mono font-bold">${Number(row['累計台数']).toLocaleString()}</td>
      <td class="p-3 text-right font-mono text-blue-700 bg-blue-50">${Number(row['月平均台数'] || 0).toLocaleString()}</td>
      <td class="p-3 ${railColor}">${railStatusText}</td>
      <td class="p-3 ${brushColor}">${brushStatusText}</td>
      <td class="p-3 ${bodyColor}">${bodyStatus}</td>
      <td class="p-3 text-center bg-green-50" data-shop-code-equipment="${row['店舗コード']}">
        <span class="text-gray-400 text-xs">-</span>
      </td>
      <td class="p-3 text-center bg-orange-50" data-shop-code-sb="${row['店舗コード']}">
        <span class="text-gray-400 text-xs">-</span>
      </td>
      <td class="p-3 text-gray-400 text-xs">${row['本体設置日']}</td>
      <td class="p-3 text-center">
        <button onclick="openMemoModal('${row['店舗コード']}', '${row['区別']}', '${memoContent.replace(/\n/g, '\\n')}')" class="${memoIconClass} text-lg transition" title="${memoTitle}">
          <i class="fas fa-sticky-note"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
    
    // ★設備構成情報を表示（キャッシュから取得）
    const shopCode = row['店舗コード'];
    const equipment = window.equipmentCache && window.equipmentCache[shopCode] ? window.equipmentCache[shopCode] : null;
    
    const cleanerCell = tr.querySelector(`td[data-shop-code-equipment="${shopCode}"]`);
    const sbCell = tr.querySelector(`td[data-shop-code-sb="${shopCode}"]`);
    
    if (equipment) {
      // 設備情報がある場合
      if (cleanerCell) {
        const cleanerCount = equipment.cleanerCount || 0;
        cleanerCell.innerHTML = `<span class="font-bold text-green-700">${cleanerCount}台</span>`;
      }
      if (sbCell) {
        const sbCount = equipment.sbCount || 0;
        if (sbCount > 0) {
          sbCell.innerHTML = `<span class="font-bold text-orange-700">${sbCount}台</span>`;
        } else {
          sbCell.innerHTML = `<span class="text-gray-400 text-xs">-</span>`;
        }
      }
    } else {
      // 設備情報がない場合（データが存在しない、またはJ列が空）
      if (cleanerCell) {
        cleanerCell.innerHTML = `<span class="text-gray-400 text-xs">-</span>`;
      }
      if (sbCell) {
        sbCell.innerHTML = `<span class="text-gray-400 text-xs">-</span>`;
      }
    }
  });
  
  updateButtonStates();
}

function openMemoModal(shopCode, machineId, currentMemo) {
  document.getElementById('memo-shop-code').value = shopCode;
  document.getElementById('memo-machine-id').value = machineId;
  document.getElementById('memo-text').value = currentMemo;
  document.getElementById('memo-modal').classList.remove('hidden');
}

function closeMemoModal() {
  document.getElementById('memo-modal').classList.add('hidden');
}

function saveMemo() {
  const shopCode = document.getElementById('memo-shop-code').value;
  const machineId = document.getElementById('memo-machine-id').value;
  const memo = document.getElementById('memo-text').value;
  
  showLoading(true);
  closeMemoModal();
  
  google.script.run
    .withSuccessHandler(() => {
      showLoading(false);
      alert('メモを保存しました。');
      managementInit();
    })
    .withFailureHandler(e => {
      showLoading(false);
      alert('保存失敗: ' + e);
    })
    .saveNextWorkMemo(shopCode, machineId, memo);
}

// チェックボックス関連の関数
function toggleSelectAll(checked) {
  const checkboxes = document.querySelectorAll('.machine-checkbox');
  checkboxes.forEach(cb => cb.checked = checked);
  updateButtonStates();
}

function updateButtonStates() {
  const checkedBoxes = document.querySelectorAll('.machine-checkbox:checked');
  const hasSelection = checkedBoxes.length > 0;
  
  document.getElementById('btn-register').disabled = !hasSelection;
  document.getElementById('btn-draft').disabled = !hasSelection;
}

function openPartsSelectionModal(actionType) {
  currentActionType = actionType;
  const checkedBoxes = document.querySelectorAll('.machine-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert('機械を選択してください。');
    return;
  }
  
  selectedMachinesData = [];
  let hasSubsidyTarget = false;
  
  checkedBoxes.forEach(cb => {
    const tr = cb.closest('tr');
    const shopCode = tr.dataset.shopCode;
    const shopName = tr.dataset.shopName;
    const machineId = tr.dataset.machineId;
    const railStatus = tr.dataset.railStatus;
    const brushStatus = tr.dataset.brushStatus;
    const bodyStatus = tr.dataset.bodyStatus;
    const isSubsidy = tr.dataset.isSubsidy === 'true';
    const nextWorkMemo = tr.dataset.nextWorkMemo || '';
    
    if (isSubsidy) hasSubsidyTarget = true;
    
    // デフォルトで選択する部品を決定
    const defaultParts = [];
    if (bodyStatus === '交換準備') {
      defaultParts.push('本体');
    } else {
      if (railStatus === '通知') {
        defaultParts.push('レール車輪');
      }
      if (brushStatus && brushStatus.includes('通知')) {
        defaultParts.push('布ブラシ');
      }
    }
    
    selectedMachinesData.push({
      shopCode: shopCode,
      shopName: shopName,
      machineId: machineId,
      railStatus: railStatus,
      brushStatus: brushStatus,
      bodyStatus: bodyStatus,
      isSubsidy: isSubsidy,
      nextWorkMemo: nextWorkMemo,
      selectedParts: [...defaultParts] // デフォルト選択をコピー
    });
  });
  
  // 警告メッセージの表示
  const warningDiv = document.getElementById('parts-selection-warning');
  if (hasSubsidyTarget) {
    warningDiv.classList.remove('hidden');
  } else {
    warningDiv.classList.add('hidden');
  }
  
  // モーダル内のリストを生成
  renderPartsSelectionList();
  
  // モーダルを表示
  document.getElementById('parts-selection-modal').classList.remove('hidden');
}

function renderPartsSelectionList() {
  const container = document.getElementById('parts-selection-list');
  container.innerHTML = '';
  
  selectedMachinesData.forEach((machine, index) => {
    const div = document.createElement('div');
    div.className = 'border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition';
    
    const subsidyBadge = machine.isSubsidy 
      ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">補助金</span>'
      : '';
    
    // ステータス表示用の色とアイコンを決定
    const getStatusBadge = (status, type) => {
      if (!status || status === '-') return '<span class="text-gray-400 text-xs">-</span>';
      if (status === '通知' || status.includes('通知')) {
        return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-300"><i class="fas fa-exclamation-triangle mr-1"></i>${status}</span>`;
      }
      if (status === '交換準備') {
        return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-orange-100 text-orange-700 border border-orange-300"><i class="fas fa-tools mr-1"></i>${status}</span>`;
      }
      return `<span class="text-gray-600 text-xs">${status}</span>`;
    };
    
    const railStatusBadge = getStatusBadge(machine.railStatus, 'rail');
    const brushStatusBadge = getStatusBadge(machine.brushStatus, 'brush');
    const bodyStatusBadge = getStatusBadge(machine.bodyStatus, 'body');
    
    // 交換が必要かどうかを判定
    const needsRail = machine.railStatus === '通知';
    const needsBrush = machine.brushStatus && machine.brushStatus.includes('通知');
    const needsBody = machine.bodyStatus === '交換準備';
    
    // 選択可能な部品を決定
    const availableParts = [];
    
    if (machine.bodyStatus === '交換準備') {
      // 本体が交換準備の場合、本体のみ選択可能
      availableParts.push({ 
        id: '本体', 
        label: '本体', 
        recommended: true,
        reason: '本体が交換準備のため',
        disabled: false
      });
    } else {
      // 本体が交換準備でない場合、全ての部品を選択可能
      availableParts.push({ 
        id: 'レール車輪', 
        label: 'レール車輪', 
        recommended: needsRail,
        reason: needsRail ? 'レールステータスが「通知」のため' : '任意で選択可能',
        disabled: false
      });
      availableParts.push({ 
        id: '布ブラシ', 
        label: '布ブラシ', 
        recommended: needsBrush,
        reason: needsBrush ? 'ブラシステータスが「通知」のため' : '任意で選択可能',
        disabled: false
      });
      availableParts.push({ 
        id: '本体', 
        label: '本体', 
        recommended: false,
        reason: '任意で選択可能',
        disabled: false
      });
    }
    
    const checkboxes = availableParts.map(part => {
      const isChecked = machine.selectedParts.includes(part.id);
      const recommendedBadge = part.recommended 
        ? '<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700 border border-blue-300"><i class="fas fa-star mr-1"></i>推奨</span>'
        : '';
      
      return `
        <div class="flex items-center p-2 rounded border ${part.recommended ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'} hover:bg-blue-100 transition">
          <label class="flex items-center cursor-pointer flex-1">
            <input type="checkbox" 
                   class="part-checkbox mr-2 w-4 h-4" 
                   data-machine-index="${index}"
                   data-part-id="${part.id}"
                   ${isChecked ? 'checked' : ''}
                   ${part.disabled ? 'disabled' : ''}
                   onchange="updateMachineParts(${index}, '${part.id}', this.checked)">
            <span class="font-medium">${part.label}</span>
            ${recommendedBadge}
          </label>
          <span class="text-xs text-gray-500 ml-2">${part.reason}</span>
        </div>
      `;
    }).join('');
    
    div.innerHTML = `
      <div class="mb-3 pb-3 border-b">
        <div class="font-bold text-gray-800 text-lg mb-1">
          ${machine.shopName}${subsidyBadge} - ${machine.machineId}
        </div>
        <div class="text-xs text-gray-500 font-mono mb-2">店舗コード: ${machine.shopCode}</div>
        <div class="flex flex-wrap gap-2 text-xs">
          <div class="flex items-center">
            <span class="text-gray-600 mr-1">レール:</span>
            ${railStatusBadge}
          </div>
          <div class="flex items-center">
            <span class="text-gray-600 mr-1">ブラシ:</span>
            ${brushStatusBadge}
          </div>
          <div class="flex items-center">
            <span class="text-gray-600 mr-1">本体:</span>
            ${bodyStatusBadge}
          </div>
        </div>
      </div>
      <div class="space-y-2">
        <div class="text-xs font-bold text-gray-600 mb-2">交換対象部品を選択:</div>
        ${checkboxes}
      </div>
    `;
    
    container.appendChild(div);
  });
}

function updateMachineParts(machineIndex, partId, isChecked) {
  if (!selectedMachinesData || !selectedMachinesData[machineIndex]) {
    console.error('updateMachineParts: 機械データが見つかりません', machineIndex);
    return;
  }
  const machine = selectedMachinesData[machineIndex];
  if (isChecked) {
    if (!machine.selectedParts.includes(partId)) {
      machine.selectedParts.push(partId);
    }
  } else {
    const index = machine.selectedParts.indexOf(partId);
    if (index > -1) {
      machine.selectedParts.splice(index, 1);
    }
  }
}

function closePartsSelectionModal() {
  document.getElementById('parts-selection-modal').classList.add('hidden');
  selectedMachinesData = [];
  currentActionType = null;
}

function confirmPartsSelection() {
  // 選択された部品があるかチェック
  if (!selectedMachinesData || selectedMachinesData.length === 0) {
    alert('機械が選択されていません。');
    return;
  }
  
  const hasSelection = selectedMachinesData.some(m => m && m.selectedParts && m.selectedParts.length > 0);
  if (!hasSelection) {
    alert('少なくとも1つの部品を選択してください。');
    return;
  }
  
  // 選択データを整形
  const formattedData = [];
  selectedMachinesData.forEach(machine => {
    if (machine && machine.selectedParts && machine.selectedParts.length > 0) {
      formattedData.push({
        shopCode: machine.shopCode,
        shopName: machine.shopName,
        machineId: machine.machineId,
        parts: machine.selectedParts,
        nextWorkMemo: machine.nextWorkMemo || ''
      });
    }
  });
  
  if (formattedData.length === 0) {
    alert('選択された部品がありません。');
    return;
  }
  
  // ★重要: currentActionTypeを保存（closePartsSelectionModalでnullになる前に）
  const actionType = currentActionType;
  
  console.log('送信データ:', formattedData);
  console.log('アクションタイプ:', actionType);
  
  if (!actionType || (actionType !== 'register' && actionType !== 'draft')) {
    alert('アクションタイプが正しく設定されていません。');
    return;
  }
  
  // モーダルを閉じる（currentActionTypeはnullになるが、actionTypeに保存済み）
  closePartsSelectionModal();
  showLoading(true);
  
  try {
    if (actionType === 'register') {
      // 案件登録のみ
      google.script.run
      .withSuccessHandler((result) => {
        showLoading(false);
        if (result && result.registeredCount !== undefined) {
          alert(`${result.registeredCount}件の案件を登録しました。`);
        } else {
          alert('案件を登録しました。');
        }
        // キャッシュをクリアして最新データを取得
        if (window.clearCache) {
          window.clearCache('progress');
          window.clearCache('dashboard');
        }
        managementInit();
        // 案件管理タブがアクティブな場合はリフレッシュ
        if (window.progressInit) {
          setTimeout(() => window.progressInit(true), 500);
        }
      })
        .withFailureHandler(e => {
          showLoading(false);
          console.error('登録エラー:', e);
          const errorMsg = e && e.message ? e.message : String(e);
          alert('登録失敗: ' + errorMsg + '\n\n詳細はブラウザのコンソールを確認してください。');
        })
        .registerSelectedProjects(formattedData);
    } else if (actionType === 'draft') {
      // メール作成 + 案件登録
      google.script.run
      .withSuccessHandler((result) => {
        showLoading(false);
        if (result && result.registeredCount !== undefined && result.draftCount !== undefined) {
          alert(`${result.registeredCount}件の案件を登録し、${result.draftCount}件のメール下書きを作成しました。`);
        } else {
          alert('案件を登録し、メール下書きを作成しました。');
        }
        // キャッシュをクリアして最新データを取得
        if (window.clearCache) {
          window.clearCache('progress');
          window.clearCache('dashboard');
        }
        managementInit();
        // 案件管理タブがアクティブな場合はリフレッシュ
        if (window.progressInit) {
          setTimeout(() => window.progressInit(true), 500);
        }
      })
        .withFailureHandler(e => {
          showLoading(false);
          console.error('処理エラー:', e);
          const errorMsg = e && e.message ? e.message : String(e);
          alert('処理失敗: ' + errorMsg + '\n\n詳細はブラウザのコンソールを確認してください。');
        })
        .createDraftsForSelected(formattedData);
    } else {
      showLoading(false);
      alert('不明なアクションタイプです。');
    }
  } catch (error) {
    showLoading(false);
    console.error('予期しないエラー:', error);
    alert('予期しないエラーが発生しました: ' + error.message);
  }
}
</script>