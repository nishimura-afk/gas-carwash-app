<!-- Progress & Process View (Integrated) -->
<div class="space-y-8">
  
  <div class="flex justify-between items-center border-b pb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-tasks mr-2"></i>案件管理</h2>
      <p class="text-sm text-gray-600">見積依頼から日程調整、作業完了報告までを一元管理します。</p>
    </div>
    <button onclick="progressInit(true)" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold transition">
      <i class="fas fa-sync-alt mr-1"></i> 最新情報を取得
    </button>
  </div>

  <!-- 1. 進行中案件リスト -->
  <div class="bg-white rounded-lg shadow border overflow-hidden">
    <!-- (ヘッダー部分は変更なし) -->
    <div class="bg-blue-50 p-4 border-b">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold text-blue-800 text-lg"><i class="fas fa-list-ul mr-2"></i>進行中の案件一覧</h3>
        <div class="text-xs text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>各行の右側にあるボタンで工程を進めます
        </div>
      </div>
      <div class="flex items-center text-xs text-gray-600 bg-white p-2 rounded border border-blue-100 shadow-sm justify-between px-4 md:px-8 overflow-x-auto">
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold mr-2">1</span>見積依頼中</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold mr-2">2</span>見積受領</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold mr-2">3</span>発注済</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold mr-2">4</span>日程確定</div>
        <div class="flex-grow border-t-2 border-gray-200 mx-2 min-w-[10px]"></div>
        <div class="flex items-center whitespace-nowrap"><span class="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold mr-2"><i class="fas fa-check"></i></span>完了</div>
      </div>
    </div>
    
    <div class="bg-gray-100 p-3 border-b text-xs font-bold text-gray-600 grid grid-cols-12 gap-4 items-center">
      <div class="col-span-4 md:col-span-3 pl-2">案件名 (店舗 / 部品)</div>
      <div class="col-span-4 md:col-span-5 text-center">現在のステータス</div>
      <div class="col-span-4 md:col-span-4 text-right pr-2">アクション</div>
    </div>
    
    <div id="progress-list-container" class="divide-y">
      <div class="p-8 text-center text-gray-500">読み込み中...</div>
    </div>
  </div>

  <!-- 2. 新規対応候補 (Alerts) -->
  <div class="bg-yellow-50 rounded-lg shadow border border-yellow-200 p-4 mt-8">
    <h3 class="text-lg font-bold text-yellow-800 mb-3"><i class="fas fa-exclamation-circle mr-2"></i>新規対応候補（未着手の警告）</h3>
    <p class="text-sm text-yellow-700 mb-4">ステータス異常が出ていますが、まだ案件化されていない機械です。「案件リストに追加（見積依頼）」するか、直接「日程登録」してください。</p>
    
    <div id="new-targets-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="text-sm text-gray-500">読み込み中...</div>
    </div>
  </div>

</div>

<!-- (モーダル群は変更なし) -->
<div id="schedule-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h3 class="text-lg font-bold mb-4 text-gray-800"><i class="fas fa-calendar-plus mr-2"></i>日程登録</h3>
    <p class="text-sm text-gray-600 mb-4" id="sched-modal-desc">施工予定日を決定してください。</p>
    <input type="hidden" id="sched-id">
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-gray-700">施工予定日</label>
      <input type="date" id="sched-date" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none">
    </div>
    <div class="flex justify-end space-x-2">
      <button onclick="closeScheduleModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
      <button onclick="submitSchedule()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold shadow">確定</button>
    </div>
  </div>
</div>
<div id="prog-complete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h3 class="text-lg font-bold mb-4 text-gray-800"><i class="fas fa-check mr-2"></i>完了報告</h3>
    <input type="hidden" id="prog-comp-id">
    <input type="hidden" id="prog-comp-part-name">
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-gray-600">完了日</label>
      <input type="date" id="prog-comp-date" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none">
    </div>
    <div class="mb-4">
      <label class="block text-sm font-bold mb-1 text-gray-600">
        完了時累計台数
        <span id="prog-count-required-badge" class="ml-2 text-xs bg-red-100 text-red-600 px-1 rounded hidden">必須</span>
      </label>
      <input type="number" id="prog-comp-count" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例: 50123">
      <p id="prog-count-optional-text" class="text-xs text-gray-400 mt-1">※布ブラシ以外は入力不要です</p>
    </div>
    <div class="flex justify-end space-x-2">
      <button onclick="closeProgCompModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
      <button onclick="submitProgCompletion()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">確定</button>
    </div>
  </div>
</div>

<script>
// ★キャッシュ対応
function progressInit(forceRefresh = false) {
  if (!forceRefresh && window.g_cache.progress) {
    renderStatusBars(window.g_cache.progress);
    if (window.g_cache.newTargets) renderNewTargets(window.g_cache.newTargets);
    return;
  }

  showLoading(true);
  google.script.run
    .withSuccessHandler(projects => {
      window.g_cache.progress = projects; // キャッシュ保存
      renderStatusBars(projects);
      
      google.script.run.withSuccessHandler(targets => {
        window.g_cache.newTargets = targets; // 新規候補もキャッシュ
        renderNewTargets(targets);
        showLoading(false);
      }).getExchangeTargetsForUI();
    })
    .withFailureHandler(e => { showLoading(false); alert('読み込みエラー: ' + e); })
    .getAllActiveProjects();
}

function renderStatusBars(projects) {
  const container = document.getElementById('progress-list-container');
  container.innerHTML = '';
  if (!projects || projects.length === 0) {
    container.innerHTML = '<div class="p-8 text-center text-gray-500">現在進行中の案件はありません</div>';
    return;
  }
  const steps = { '見積依頼中': 1, '見積受領': 2, '発注済': 3, '未完了': 4 };
  projects.sort((a, b) => (steps[b.status] || 0) - (steps[a.status] || 0));

  projects.forEach(p => {
    const currentStep = steps[p.status] || 0;
    const dateDisplay = p.date ? `<span class="ml-2 text-xs font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded"><i class="fas fa-clock mr-1"></i>${p.date}</span>` : '';
    const progressWidth = (currentStep / 4) * 100;
    const barColor = currentStep === 4 ? 'bg-green-500' : 'bg-blue-500';
    let statusLabel = p.status;
    if(p.status === '未完了') statusLabel = '日程確定済';

    let actionBtn = '';
    let backBtn = '';
    if (p.status === '見積依頼中') {
      actionBtn = `<button onclick="updateStatus('${p.id}', '見積受領')" class="bg-indigo-500 text-white px-3 py-1.5 rounded text-xs hover:bg-indigo-600 shadow font-bold">見積受領へ <i class="fas fa-arrow-right ml-1"></i></button>`;
    } else if (p.status === '見積受領') {
      actionBtn = `<button onclick="updateStatus('${p.id}', '発注済')" class="bg-orange-500 text-white px-3 py-1.5 rounded text-xs hover:bg-orange-600 shadow font-bold">発注済へ <i class="fas fa-arrow-right ml-1"></i></button>`;
      backBtn = `<button onclick="revertStatus('${p.id}', '見積依頼中')" class="text-gray-400 hover:text-gray-600 px-2" title="ひとつ前に戻す"><i class="fas fa-undo"></i></button>`;
    } else if (p.status === '発注済') {
      actionBtn = `<button onclick="openScheduleModal('${p.id}', '${p.shopName}', '${p.part}')" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs hover:bg-green-700 shadow font-bold"><i class="fas fa-calendar-plus mr-1"></i>日程登録</button>`;
      backBtn = `<button onclick="revertStatus('${p.id}', '見積受領')" class="text-gray-400 hover:text-gray-600 px-2" title="ひとつ前に戻す"><i class="fas fa-undo"></i></button>`;
    } else if (p.status === '未完了') { 
      actionBtn = `<button onclick="openProgCompModal('${p.id}', '${p.date}', '${p.part}')" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 shadow font-bold"><i class="fas fa-check mr-1"></i>完了報告</button>`;
      backBtn = `<button onclick="revertStatus('${p.id}', '発注済')" class="text-gray-400 hover:text-gray-600 px-2" title="日程を取り消して発注済に戻す"><i class="fas fa-undo"></i></button>`;
    }

    const item = document.createElement('div');
    item.className = "p-3 hover:bg-gray-50 grid grid-cols-12 gap-4 items-center";
    item.innerHTML = `
      <div class="col-span-4 md:col-span-3 pl-2"><div class="font-bold text-gray-800 text-sm">${p.shopName}</div><div class="text-xs text-gray-500">区分: ${p.machineId} | ${p.part}</div><div class="mt-1">${dateDisplay}</div></div>
      <div class="col-span-4 md:col-span-5 relative h-6 bg-gray-200 rounded-full overflow-hidden shadow-inner">
        <div class="absolute inset-0 grid grid-cols-4 w-full h-full"><div class="border-r border-white/50"></div><div class="border-r border-white/50"></div><div class="border-r border-white/50"></div><div></div></div>
        <div class="absolute top-0 left-0 h-full ${barColor} flex items-center justify-end pr-2 text-white text-[10px] font-bold transition-all duration-500" style="width: ${progressWidth}%">${statusLabel}</div>
      </div>
      <div class="col-span-4 md:col-span-4 text-right flex justify-end items-center gap-2">${backBtn}${actionBtn}<button onclick="deleteProject('${p.id}')" class="text-gray-300 hover:text-red-500 transition ml-2 border-l pl-2" title="案件削除"><i class="fas fa-trash-alt"></i></button></div>
    `;
    container.appendChild(item);
  });
}

function renderNewTargets(list) {
  const container = document.getElementById('new-targets-container');
  container.innerHTML = '';
  if (list.length === 0) {
    container.innerHTML = '<div class="col-span-3 p-4 text-center text-gray-500">新規の対応候補はありません</div>';
    return;
  }
  list.forEach(item => {
    let subsidyBadge = '';
    if (item.subsidyAlert) {
      subsidyBadge = `<div class="text-xs text-red-600 bg-red-50 border border-red-200 p-1 rounded mt-1"><i class="fas fa-yen-sign mr-1"></i>補助金注意</div>`;
    }
    const card = document.createElement('div');
    card.className = "bg-white p-3 rounded shadow border hover:shadow-md transition";
    card.innerHTML = `
      <div class="flex justify-between items-start">
        <div><div class="font-bold text-gray-800">${item.shopName}</div><div class="text-xs text-gray-500">${item.exchangeTargets}</div>${subsidyBadge}</div>
        <div class="flex flex-col gap-1"><button onclick="directSchedule('${item.shopCode}', '${item.machineIdentifier}', '${item.exchangeTargets}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs hover:bg-yellow-600 whitespace-nowrap"><i class="fas fa-calendar-plus mr-1"></i>日程登録</button></div>
      </div>
    `;
    container.appendChild(card);
  });
}

// --- アクション処理 ---
function updateStatus(id, newStatus) {
  if (!confirm(`ステータスを「${newStatus}」に進めますか？`)) return;
  showLoading(true);
  google.script.run.withSuccessHandler(() => {
    alert('ステータスを更新しました。');
    clearCache('progress');
    progressInit(true);
  }).withFailureHandler(e => { showLoading(false); alert('更新失敗: ' + e); }).updateProjectStatus(id, newStatus);
}

function revertStatus(id, prevStatus) {
  if (!confirm(`ステータスを「${prevStatus}」に戻しますか？`)) return;
  showLoading(true);
  google.script.run.withSuccessHandler(() => {
    alert('ステータスを戻しました。');
    clearCache('progress');
    progressInit(true);
  }).withFailureHandler(e => { showLoading(false); alert('更新失敗: ' + e); }).updateProjectStatus(id, prevStatus);
}

function deleteProject(id) {
  if (!confirm('この案件を取り消しますか？\n（履歴上は「取り消し」として残ります）')) return;
  showLoading(true);
  google.script.run.withSuccessHandler(() => {
    alert('案件を取り消しました。');
    clearCache('progress');
    progressInit(true);
  }).withFailureHandler(e => { showLoading(false); alert('削除失敗: ' + e); }).cancelProject(id);
}

// (以下、モーダル系は変更なしだが、完了時のrefresh呼び出しでキャッシュクリアを含める)
function openScheduleModal(id, shopName, part) {
  document.getElementById('sched-id').value = id;
  document.getElementById('sched-date').value = '';
  document.getElementById('sched-modal-desc').innerText = `${shopName} の ${part} 交換日程を登録します。`;
  document.getElementById('schedule-modal').classList.remove('hidden');
}

let directRegisterData = null;
function directSchedule(shopCode, machineId, part) {
  directRegisterData = { shopCode, machineId, part };
  document.getElementById('sched-id').value = 'DIRECT';
  document.getElementById('sched-date').value = '';
  document.getElementById('sched-modal-desc').innerText = `新規登録: ${part} の交換日程を登録します。`;
  document.getElementById('schedule-modal').classList.remove('hidden');
}

function closeScheduleModal() {
  document.getElementById('schedule-modal').classList.add('hidden');
  directRegisterData = null;
}

function submitSchedule() {
  const id = document.getElementById('sched-id').value;
  const date = document.getElementById('sched-date').value;
  if(!date) { alert('日付を選択してください'); return; }
  
  showLoading(true);
  closeScheduleModal();
  const notes = "統合管理画面からの登録";

  if (id === 'DIRECT' && directRegisterData) {
    google.script.run.withSuccessHandler(() => {
      alert('日程を登録しました');
      clearCache('progress');
      progressInit(true);
    }).withFailureHandler(e => { showLoading(false); alert('登録失敗: ' + e); }).createScheduleAndRecord(directRegisterData.shopCode, directRegisterData.machineId, directRegisterData.part, date, notes);
  } else {
    google.script.run.withSuccessHandler(() => {
      alert('日程を確定しました');
      clearCache('progress');
      progressInit(true);
    }).withFailureHandler(e => { showLoading(false); alert('更新失敗: ' + e); }).createScheduleAndRecord("", "", "", date, notes, id);
  }
}

function openProgCompModal(id, scheduledDate, partName) {
  document.getElementById('prog-comp-id').value = id;
  document.getElementById('prog-comp-part-name').value = partName;
  if(scheduledDate) document.getElementById('prog-comp-date').value = scheduledDate.replace(/\//g, '-');
  else document.getElementById('prog-comp-date').valueAsDate = new Date();
  
  const isBrush = partName.includes('布ブラシ');
  const countInput = document.getElementById('prog-comp-count');
  if (isBrush) {
    document.getElementById('prog-count-required-badge').classList.remove('hidden');
    document.getElementById('prog-count-optional-text').classList.add('hidden');
    countInput.placeholder = "必須入力";
  } else {
    document.getElementById('prog-count-required-badge').classList.add('hidden');
    document.getElementById('prog-count-optional-text').classList.remove('hidden');
    countInput.placeholder = "任意入力";
    countInput.value = ""; 
  }
  document.getElementById('prog-complete-modal').classList.remove('hidden');
}

function closeProgCompModal() {
  document.getElementById('prog-complete-modal').classList.add('hidden');
}

function submitProgCompletion() {
  const id = document.getElementById('prog-comp-id').value;
  const date = document.getElementById('prog-comp-date').value;
  let count = document.getElementById('prog-comp-count').value;
  const partName = document.getElementById('prog-comp-part-name').value;
  
  if (!date) { alert('完了日は必須です'); return; }
  if (partName.includes('布ブラシ') && !count) { alert('布ブラシ交換の場合は「完了時累計台数」が必須です'); return; }
  if (!count) count = 0;
  
  showLoading(true);
  closeProgCompModal();
  
  google.script.run
    .withSuccessHandler(() => {
      alert('完了報告を記録しました');
      clearCache('progress');
      progressInit(true);
    })
    .withFailureHandler(e => { showLoading(false); alert('エラー: ' + e); })
    .completeExchange(id, date, count);
}
</script>